name: build_publish_snap

on:
   push:
      branches: [main]
      paths-ignore:
         - "**/*.md"
         - "**/.gitignore"
         - "**/.gitattributes"
   pull_request:
      branches: [main]
      paths-ignore:
         - "**/*.md"
         - "**/.gitignore"
         - "**/.gitattributes"

jobs:
   build-and-release:
      runs-on: ubuntu-latest

      steps:
         - uses: actions/checkout@v3

         - name: Set up Node.js
           uses: actions/setup-node@v3
           with:
              node-version: "22"

         - name: Install dependencies
           run: npm install

         - name: Run tests (Electron sandbox disabled)
           run: npm run ci-test

         - name: Build Snap package
           env:
              ELECTRON_DISABLE_SANDBOX: 1
           run: npm run build

         - name: Upload build artifacts
           uses: actions/upload-artifact@v4
           with:
              name: electron-build
              path: dist/
              if-no-files-found: error

         - name: Create GitHub Release (no tag)
           uses: softprops/action-gh-release@v1
           with:
              files: dist/*.snap
           env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

         - name: Install Snapcraft
           run: sudo snap install snapcraft --classic

         - name: Login to Snapcraft
           env:
              SNAPCRAFT_LOGIN_TOKEN: ${{ secrets.SNAPCRAFT_LOGIN_TOKEN }}
           run: echo "$SNAPCRAFT_LOGIN_TOKEN" | snapcraft login --with -

         - name: Push Snap package to Ubuntu Store
           run: snapcraft push dist/*.snap --release stable
